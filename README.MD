# Autentica√ß√£o com Spring Security

Este projeto implementa uma autentica√ß√£o simples utilizando o Spring Security. O objetivo √© oferecer uma maneira segura de autenticar usu√°rios no sistema.

## Principais Classes

### [SecurityConfigurations](https://github.com/thomazcm/spring-authentication/blob/master/src/main/java/br/com/businesstec/springauthentication/config/SecurityConfigurations.java)

A classe `SecurityConfigurations` √© respons√°vel pelas principais configura√ß√µes de seguran√ßa da aplica√ß√£o. Ela define os endpoints que necessitam de autentica√ß√£o, o encoder para as senhas, os formul√°rios de login etc.

Importante ter as anota√ß√µes @EnableWebSecurity e @Configuration

Essas anota√ß√µes s√£o usadas para ativar a seguran√ßa web no Spring Security e indicar que √© uma classe de configura√ß√£o e pode conter m√©todos @Bean ou configura√ß√µes do Spring.

### [LoginController](https://github.com/thomazcm/spring-authentication/blob/master/src/main/java/br/com/businesstec/springauthentication/controller/LoginController.java)

A classe `LoginController` apenas administra a navega√ß√£o para a p√°gina de login. N√£o √© necess√°rio criar um m√©todo @PostMapping para login pois isso j√° √© feito de forma autom√°tica com as configura√ß√µes do Spring Security.

O template [login.html](https://github.com/thomazcm/spring-authentication/blob/master/src/main/resources/templates/login.html) possui o formul√°rio que direciona POST para /login com as informa√ß√µes do formul√°rio e a autentica√ß√£o √© feita.

√â poss√≠vel no entanto [configurar esse processo de forma manual](#login-manual), por exemplo para usar autentica√ß√£o por Token.


### [AuthenticationService](https://github.com/thomazcm/spring-authentication/blob/master/src/main/java/br/com/businesstec/springauthentication/config/AuthenticationService.java)

A classe `AuthenticationService` √© um servi√ßo injetado na SecurityConfigurations que implementa a interface `UserDetailsService` do Spring Security. Ela √© respons√°vel por fazer a liga√ß√£o entre o Spring Security e o banco de dados.


### [IndexController](https://github.com/thomazcm/spring-authentication/blob/master/src/main/java/br/com/businesstec/springauthentication/controller/IndexController)

A classe `IndexController` √© um exemplo de um redirecionamento para uma p√°gina inicial ap√≥s o login bem sucedido (n√£o √© preciso especificar redirect pois isso j√° √© feito de forma autom√°tica na SecurityConfigurations)

Nela √© demonstrado tamb√©m como user o SecurityContextHolder para obter o atual usu√°rio logado.

## Navega√ß√£o
Foram criados 3 templates simples para [login](https://github.com/thomazcm/spring-authentication/blob/master/src/main/resources/templates/login.html) / [cadastro](https://github.com/thomazcm/spring-authentication/blob/master/src/main/resources/templates/cadastro.html) / [index](https://github.com/thomazcm/spring-authentication/blob/master/src/main/resources/templates/index.html)

## Cadastro de Usu√°rios e Administradores
O cadastro de novos usu√°rios pode ser feito de duas formas, pelo formul√°rio ou por requisi√ß√µes REST. O cadastro de novos administradores s√≥ pode ser feito por requests e apenas por administradores autenticados.

### [UserEndpoint](https://github.com/thomazcm/spring-authentication/blob/master/src/main/java/br/com/businesstec/springauthentication/endpoint/UserEndpoint.java)

A classe `UserEndpoint` √© um exemplo de uma configura√ß√£o para cadastro de novos usu√°rios e administradores do sistema atrav√©s de requisi√ß√µes em uma API REST.

### [CadastroController](https://github.com/thomazcm/spring-authentication/blob/master/src/main/java/br/com/businesstec/springauthentication/controller/CadastroController.java)

A classe `CadastroController` adminsitra a view do formul√°rio de cadastro de usu√°rios e faz o cadastro. 

## Modelo

### [User](https://github.com/thomazcm/spring-authentication/blob/master/src/main/java/br/com/businesstec/springauthentication/model/User.java)

A classe `User` √© uma entidade que representa um usu√°rio na aplica√ß√£o e implementa a interface `UserDetails` e tem uma rela√ß√£o com a Class `Profile`. Ela cont√©m detalhes como o email do usu√°rio e a senha.

### [Profile](https://github.com/thomazcm/spring-authentication/blob/master/src/main/java/br/com/businesstec/springauthentication/model/Profile.java)

A classe `Profile` √© uma entidade que representa o perfil de autentica√ß√£o de um usu√°rio na aplica√ß√£o. Cada usu√°rio pode ter m√∫ltiplos perfis, como "USER" ou "ADMIN". Ela implementa a interface do Spring Security `GrantedAuthority `.


### Login Manual
Caso seja necess√°rio configurar o login, por exemplo em um endpoint "/auth":
```java
 @PostMapping("/auth")
    public ResponseEntity<?> authenticate(@RequestBody LoginForm form, HttpServletResponseresponse) {
        UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(form.getEmail(), form.getPassword());
        try {
            Authentication authentication = authenticationManager.authenticate(authenticationToken);
            User user = (User) authentication.getPrincipal();
            String jwtToken = jwtService.createToken(user);
            Cookie freshCookie = cookieService.createFreshCookie(jwtToken);
            response.addCookie(freshCookie);
            return ResponseEntity.ok(new UserDto(user));
        } catch (AuthenticationException) {
            logger.error("authentication failed for user " + form.getEmail()+ System.lineSeparator() + e.getMessage());
            return ResponseEntity.badRequest().build();
        }
    }
```
Nesse exemplo a autentica√ß√£o √© feita na chamada do m√©todo authenticationManager.authenticate(authenticationToken);
E caso o login falhe √© lan√ßada uma AuthenticationException.

Se a autentica√ß√£o n√£o falhar, nesse caso ser√° gerado um novo token que √© retornado na resposta. 
Para evitar que o Spring crie uma nova sess√£o √© usada na classe `SecurityConfigurations` a configura√ß√£o:
```java
http.
// outras configura√ß√µes
.sessionManagement(
    session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .invalidSessionUrl("/login"));

```

## Principais Depend√™ncias

#### Spring Security

Spring Security √© um framework de autentica√ß√£o e controle de acesso altamente personaliz√°vel. 

#### Spring-JPA e PostgreSQL conector
Banco de dados

### Thymeleaf
No projeto foi usado thymeleaf para gerar as p√°ginas simples de login, e de acesso bem sucedido demonstrando a informa√ß√£o do id do usu√°rio no banco de dados.

## Executando o Projeto

Para executar este projeto, ajuste as configura√ß√µes do banco de dados no arquivo application.properties de acordo com sua instala√ß√£o do PostGres

Clone o reposit√≥rio e navegue at√© o diret√≥rio do projeto:

```bash
git clone [link-do-repositorio]
cd spring-authentication

```
Agora, voc√™ pode construir o projeto e execut√°-lo:

```bash
Copy code
mvn clean install
mvn spring-boot:run
```
A aplica√ß√£o estar√° rodando no endere√ßo http://localhost:8080/


## Author
<b>Thomaz Machado</b>üöÄ<br />
 <img style="border-radius: 50%;" src="https://avatars.githubusercontent.com/u/71472870?s=460&u=61b426b901b8fe02e12019b1fdb67bf0072d4f00&v=4" width="100px;" alt=""/><br />
Project developed by Thomaz Machado. Get in touch!  

[![Linkedin Badge](https://img.shields.io/badge/-Thomaz-blue?style=flat-square&logo=Linkedin&logoColor=white&link=https://www.linkedin.com/in/thomazcm)](https://www.linkedin.com/in/thomazcm) 
[![Gmail Badge](https://img.shields.io/badge/-thomazcm@gmail.com-c14438?style=flat-square&logo=Gmail&logoColor=white&link=mailto:thomazcm@gmail.com)](mailto:thomazcm@gmail.com)
 
 <p align="right">(<a href="#readme-top">back to top
</a>)</p>